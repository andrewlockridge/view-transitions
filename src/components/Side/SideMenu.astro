---
import SideMenuItem from "./SideMenuItem.astro";
import { sidebarPlaylists, getSortedPlaylists } from "../../lib/data";
import SideItemCard from "./SideItemCard.astro";

// IMPORTANT: Use getSortedPlaylists to get the sorted list
const sortedPlaylists = getSortedPlaylists(sidebarPlaylists);
---

<div class="flex flex-col flex-1 gap-2">
  <div class="bg-zinc-900 rounded-lg">
    <ul>
      <SideMenuItem href="/" iconName="carbon:home">Home</SideMenuItem>
      <SideMenuItem href="#" iconName="carbon:search">Search</SideMenuItem>
    </ul>
  </div>

  <div class="bg-zinc-900 rounded-lg flex-1">
    <ul>
      <SideMenuItem href="#" iconName="carbon:media-library">
        Your library
      </SideMenuItem>
    </ul>
    <ul class="pl-2" id="playlist-container">
      {sortedPlaylists.map((playlist) => <SideItemCard playlist={playlist} />)}
    </ul>
  </div>
</div>

<script>
  function reorderPlaylists() {
    const container = document.getElementById('playlist-container');
    if (!container) return;

    const playlistElements = Array.from(container.querySelectorAll('.playlist-item'));
    const playlists = playlistElements.map(el => ({
      id: el.getAttribute('data-playlist-id') || '',
      element: el
    }));

    // Get the sorted order from localStorage
    const likedPlaylistsArray = JSON.parse(localStorage.getItem('likedPlaylists') || '[]');
    const sortedIds = new Set(likedPlaylistsArray);
    
    playlists.sort((a, b) => {
      const aLiked = sortedIds.has(a.id);
      const bLiked = sortedIds.has(b.id);
      
      if (aLiked && !bLiked) return -1;
      if (!aLiked && bLiked) return 1;
      return 0;
    });

    // Reorder the DOM elements
    playlists.forEach(({ element }) => {
      container.appendChild(element);
    });
  }

  // Initial reorder on page load
  document.addEventListener('DOMContentLoaded', () => {
    reorderPlaylists();
  });

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', () => {
    reorderPlaylists();
  });

  // Listen for storage changes (for cross-tab sync)
  window.addEventListener('storage', (e) => {
    if (e.key === 'likedPlaylists') {
      reorderPlaylists();
    }
  });
</script>
