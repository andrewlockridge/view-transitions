---
import type { Playlist } from "../../lib/data";
import InlineArtists from "../InlineArtists.astro";
import PlayButton from "../PlayButton.astro";
import PureInlineArtists from "../PureInlineArtists.astro";
interface Props {
  playlist: Playlist;
}

const { playlist } = Astro.props;
---

<li>
  <a
    href={`/playlist/${playlist.id}`}
    class="playlist-item flex group relative p-2 overflow-hidden items-center gap-3 rounded-md hover:bg-zinc-800 transition-colors"
    data-playlist-id={playlist.id}
  >
    <div class="h-12 w-12 flex-none">
      <img
        src={playlist.cover}
        alt={playlist.title}
        class="object-cover rounded h-full w-full shadow-lg"
      />
    </div>
    <div class="flex flex-auto flex-col truncate min-w-0">
      <div class="font-semibold w-full flex-none truncate text-sm">
        {playlist.title}
      </div>
      <div class="text-gray-400 text-xs truncate flex-1">
        <PureInlineArtists artists={playlist.artists} />
      </div>
    </div>
    <button
      data-playlist-id={playlist.id}
      class="like-button opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-2 hover:scale-110 flex-none z-10"
      aria-label={`Like ${playlist.title}`}
      type="button"
    >
      <svg class="heart-icon w-4 h-4 fill-current text-zinc-400 hover:text-red-500 transition-colors" viewBox="0 0 24 24">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </button>
  </a>
</li>

<script>
  import { isPlaylistLiked, togglePlaylistLike } from '../../lib/data';

  function initializeLikeButtons() {
    const likeButtons = document.querySelectorAll('.like-button');
    
    likeButtons.forEach((button) => {
      const playlistId = button.getAttribute('data-playlist-id');
      if (!playlistId) return;
      
      const heartIcon = button.querySelector('.heart-icon');
      if (!heartIcon) return;
      
      // Set initial state based on localStorage
      if (isPlaylistLiked(playlistId)) {
        button.classList.remove('opacity-0');
        heartIcon.classList.add('text-red-500');
        heartIcon.classList.remove('text-zinc-400');
      } else {
        button.classList.add('opacity-0');
        heartIcon.classList.add('text-zinc-400');
        heartIcon.classList.remove('text-red-500');
      }
      
      // Remove any existing listeners to prevent duplicates
      const newButton = button.cloneNode(true) as HTMLElement;
      button.parentNode?.replaceChild(newButton, button);
      
      // Add click handler to the new button
      newButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const newHeartIcon = newButton.querySelector('.heart-icon');
        if (!newHeartIcon) return;
        
        const isLiked = togglePlaylistLike(playlistId);
        
        // Update visual state immediately
        if (isLiked) {
          newHeartIcon.classList.add('text-red-500');
          newHeartIcon.classList.remove('text-zinc-400');
        } else {
          newHeartIcon.classList.add('text-zinc-400');
          newHeartIcon.classList.remove('text-red-500');
        }
        
        // Trigger a page reload to re-sort the playlists
        setTimeout(() => {
          window.location.reload();
        }, 300);
      });
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeLikeButtons);
  } else {
    initializeLikeButtons();
  }

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:page-load', () => {
    initializeLikeButtons();
  });
</script>
